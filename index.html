<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ user.username }} - Информация о подписке</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        /* Небольшие дополнительные стили для центрирования и отступов */
        body {
            background-color: #f8f9fa; /* Светлый фон для контраста */
        }
        .container {
            max-width: 800px; /* Ограничиваем ширину для лучшей читаемости */
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .card {
            margin-bottom: 1.5rem;
        }
        .accordion-button:not(.collapsed) {
            background-color: #e7f1ff; /* Легкий цвет фона для активного аккордеона */
        }
        .app-icon { /* Стиль для иконок приложений (если будете добавлять) */
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }
        .os-icon { /* Стиль для иконок ОС */
            width: 20px;
            height: 20px;
            margin-right: 10px;
            vertical-align: middle;
        }
        /* Цвета для прогресс-бара в зависимости от % */
        .progress-bar.bg-success { background-color: #198754 !important; } /* < 40% */
        .progress-bar.bg-warning { background-color: #ffc107 !important; } /* 40-80% */
        .progress-bar.bg-danger { background-color: #dc3545 !important; }  /* > 80% */
    </style>
</head>
<body>

<div class="container">
    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-3">Данные пользователя {{ user.username }}</h5>
            <p><strong>Статус:</strong>
                <span id="user-status-badge" class="badge">Загрузка...</span>
            </p>
            <p><strong>Срок действия:</strong> <span id="expire-date">Загрузка...</span></p>
            <p><strong>Осталось дней:</strong> <span id="remaining-days">{% if not user.expire %}∞{% else %}{% set remaining_days = ((user.expire - now().timestamp()) // (24 * 3600)) %}{{ remaining_days | int if (remaining_days | int) > -1 else 0 }}{% endif %}</span></p>
            <p id="reset-info" class="text-muted small">Загрузка...</p>

            <h6 class="mt-4">Использование трафика:</h6>
            <div class="progress" role="progressbar" aria-label="Data usage" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="height: 25px;">
                <div id="data-usage-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
            </div>
            <p class="mt-2 text-center">
                <span id="traffic-usage-text">Использовано: {{ user.used_traffic | bytesformat }} / {% if not user.data_limit %}∞{% else %}{{ user.data_limit | bytesformat }}{% endif %}</span>
            </p>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-3">VPN Клиенты и Настройка</h5>
            <p>Скачайте приложение для своей ОС.</p>
            <p>Большинство программ имеют схожий функционал и отличаются только некоторыми фичами и интерфейсом. Выбирайте на свой вкус.</p>

            <div class="accordion" id="vpnClientsAccordion">

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingIos">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseIos" aria-expanded="false" aria-controls="collapseIos">
                            <img src="https://img.icons8.com/ios-filled/50/000000/mac-os.png" alt="iOS" class="os-icon"/>
                            iOS
                        </button>
                    </h2>
                    <div id="collapseIos" class="accordion-collapse collapse" aria-labelledby="headingIos" data-bs-parent="#vpnClientsAccordion">
                        <div class="accordion-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Streisand (рекомендуется)
                                    <div>
                                        <a href="https://apps.apple.com/us/app/streisand/id6450534064" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Загрузить</a>
                                        <a id="ios-streisand-add" href="#" class="btn btn-sm btn-primary">Добавить подписку</a>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    V2Box
                                    <div>
                                        <a href="https://apps.apple.com/us/app/v2box-v2ray-client/id6446814690" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Загрузить</a>
                                        <a id="ios-v2box-add" href="#" class="btn btn-sm btn-primary">Добавить подписку</a>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Sing-Box
                                    <div>
                                        <a href="https://apps.apple.com/us/app/sing-box/id6451272673" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Загрузить</a>
                                        <a id="ios-singbox-add" href="#" class="btn btn-sm btn-primary">Добавить подписку</a>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Shadowrocket
                                    <div>
                                        <a href="https://apps.apple.com/us/app/shadowrocket/id932747118" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Загрузить</a>
                                        <a id="ios-shadowrocket-add" href="#" class="btn btn-sm btn-primary">Добавить подписку</a>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    foXray
                                    <div>
                                        <a href="https://apps.apple.com/us/app/foxray/id6448898396" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Загрузить</a>
                                        <a id="ios-foxray-add" href="#" class="btn btn-sm btn-primary">Добавить подписку</a>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingAndroid">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAndroid" aria-expanded="false" aria-controls="collapseAndroid">
                            <img src="https://img.icons8.com/material-outlined/24/000000/android-os.png" alt="Android" class="os-icon"/>
                            Android
                        </button>
                    </h2>
                    <div id="collapseAndroid" class="accordion-collapse collapse" aria-labelledby="headingAndroid" data-bs-parent="#vpnClientsAccordion">
                        <div class="accordion-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    v2rayNG (рекомендуется)
                                    <div>
                                        <a href="https://play.google.com/store/apps/details?id=com.v2ray.ang" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Google Play</a>
                                        <a href="https://github.com/2dust/v2rayNG/releases" target="_blank" class="btn btn-sm btn-outline-secondary me-2">GitHub (APK)</a>
                                        <a id="android-v2rayng-add" href="#" class="btn btn-sm btn-primary">Добавить подписку</a>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    NekoBox
                                    <div>
                                        <a href="https://github.com/MatsuriDayo/NekoBoxForAndroid/releases" target="_blank" class="btn btn-sm btn-outline-secondary me-2">GitHub (APK)</a>
                                        <a id="android-nekobox-add" href="#" class="btn btn-sm btn-primary">Добавить подписку</a>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Sing-Box
                                    <div>
                                        <a href="https://play.google.com/store/apps/details?id=io.nekohasekai.sfa" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Google Play</a>
                                        <a href="https://github.com/SagerNet/sing-box/releases" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Github (APK)</a>
                                        <a id="android-singbox-add" href="#" class="btn btn-sm btn-primary">Добавить подписку</a>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingWindows">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseWindows" aria-expanded="false" aria-controls="collapseWindows">
                            <img src="https://img.icons8.com/ios-filled/50/000000/windows-logo.png" alt="Windows" class="os-icon"/>
                            Windows
                        </button>
                    </h2>
                    <div id="collapseWindows" class="accordion-collapse collapse" aria-labelledby="headingWindows" data-bs-parent="#vpnClientsAccordion">
                        <div class="accordion-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    v2rayN (рекомендуется)
                                    <div>
                                        <a href="https://github.com/2dust/v2rayN/releases" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Загрузить (GitHub)</a>
                                        <button onclick="copyToClipboard('{{ user.subscription_url }}', this)" class="btn btn-sm btn-primary">Копировать ссылку</button>
                                        <small class="d-block text-muted">Вставьте ссылку в программу</small>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    NekoRay
                                    <div>
                                        <a href="https://github.com/MatsuriDayo/nekoray/releases" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Загрузить (GitHub)</a>
                                        <button onclick="copyToClipboard('{{ user.subscription_url }}', this)" class="btn btn-sm btn-primary">Копировать ссылку</button>
                                        <small class="d-block text-muted">Вставьте ссылку в программу</small>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Clash Verge
                                    <div>
                                        <a href="https://github.com/zzzgydi/clash-verge/releases" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Загрузить (GitHub)</a>
                                        <a id="windows-clashverge-add" href="#" class="btn btn-sm btn-primary">Добавить подписку</a>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingMacOs">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMacOs" aria-expanded="false" aria-controls="collapseMacOs">
                            <img src="https://img.icons8.com/ios-filled/50/000000/mac-os.png" alt="macOS" class="os-icon"/>
                            macOS
                        </button>
                    </h2>
                    <div id="collapseMacOs" class="accordion-collapse collapse" aria-labelledby="headingMacOs" data-bs-parent="#vpnClientsAccordion">
                        <div class="accordion-body">
                            <p class="text-muted">Используйте клиенты для iOS или универсальные клиенты, такие как NekoRay или Clash Verge.</p>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    NekoRay
                                    <div>
                                        <a href="https://github.com/MatsuriDayo/nekoray/releases" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Загрузить (GitHub)</a>
                                        <button onclick="copyToClipboard('{{ user.subscription_url }}', this)" class="btn btn-sm btn-primary">Копировать ссылку</button>
                                        <small class="d-block text-muted">Вставьте ссылку в программу</small>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Clash Verge
                                    <div>
                                        <a href="https://github.com/zzzgydi/clash-verge/releases" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Загрузить (GitHub)</a>
                                        <button onclick="copyToClipboard('{{ user.subscription_url }}', this)" class="btn btn-sm btn-primary">Копировать ссылку</button> <small class="d-block text-muted">Вставьте ссылку в программу</small>
                                    </div>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Sing-Box GUI
                                    <div>
                                        <a href="https://github.com/SagerNet/sing-box/releases" target="_blank" class="btn btn-sm btn-outline-secondary me-2">Загрузить (GitHub)</a>
                                        <button onclick="copyToClipboard('{{ user.subscription_url }}', this)" class="btn btn-sm btn-primary">Копировать ссылку</button>
                                        <small class="d-block text-muted">Вставьте ссылку в программу</small>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body text-center">
            <h5 class="card-title mb-3">Ссылка подписки</h5>
            <div class="input-group mb-3">
                <input type="text" id="subLinkInput" class="form-control" value="{{ user.subscription_url }}" readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(fullUrl, this)">Копировать</button> </div>
            <button class="btn btn-info" type="button" data-bs-toggle="modal" data-bs-target="#qrModal">
                Показать QR-код
            </button>
        </div>
    </div>

    <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrModalLabel">QR-код подписки</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="qrcode" class="d-inline-block p-2 bg-white rounded"></div>
                </div>
            </div>
        </div>
    </div>

</div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script>
    // ----- Инициализация переменных из шаблона Marzban -----
    const subUrlRaw = "{{ user.subscription_url }}";
    // Формируем полную URL подписки, если она относительная
    let fullUrl = subUrlRaw;
    if (!subUrlRaw.startsWith("http")) {
        const baseUrl = window.location.origin;
        const path = subUrlRaw.startsWith('/') ? subUrlRaw.substring(1) : subUrlRaw;
        fullUrl = `${baseUrl}/${path}`;
    }

    const dataLimitBytes = {% if not user.data_limit %}0{% else %}{{ user.data_limit }}{% endif %}; // В байтах
    const dataUsedBytes = {{ user.used_traffic }}; // В байтах
    const userStatus = '{{ user.status.value }}'; // 'active', 'limited', 'expired', 'disabled'
    const expireTimestamp = {% if not user.expire %}null{% else %}{{ user.expire }}{% endif %}; // Unix timestamp
    const resetStrategy = '{{ user.data_limit_reset_strategy.value }}'; // 'no_reset', 'day', 'week', 'month', 'year'
    const username = '{{ user.username | urlencode }}'; // Получаем имя пользователя и кодируем его для URL

    // ----- Функции -----

    /**
     * Форматирует байты в читаемый формат (KB, MB, GB).
     * @param {number} bytes - Количество байт.
     * @param {number} [decimals=2] - Количество знаков после запятой.
     * @returns {string} - Отформатированная строка.
     */
    function formatBytes(bytes, decimals = 2) {
        if (!+bytes) return '0 Bytes'
        // Не показываем '∞' здесь, если лимит 0, лучше показать объем использованного
        // if (dataLimitBytes === 0) return '∞';

        const k = 1024
        const dm = decimals < 0 ? 0 : decimals
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']

        const i = Math.floor(Math.log(bytes) / Math.log(k))

        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`
    }

    /**
     * Копирует текст в буфер обмена и временно меняет текст кнопки.
     * @param {string} textToCopy - Текст для копирования.
     * @param {HTMLElement} buttonElement - Кнопка, на которую нажали.
     */
    function copyToClipboard(textToCopy, buttonElement) {
        navigator.clipboard.writeText(textToCopy).then(() => {
            const originalText = buttonElement.innerHTML;
            const originalClasses = buttonElement.className; // Сохраняем исходные классы
            buttonElement.textContent = 'Скопировано!';
            buttonElement.className = 'btn btn-sm btn-success'; // Устанавливаем классы для успеха

            setTimeout(() => {
                buttonElement.innerHTML = originalText;
                buttonElement.className = originalClasses; // Восстанавливаем исходные классы
            }, 2000);
        }).catch(err => {
            console.error('Ошибка копирования: ', err);
            alert('Не удалось скопировать ссылку.');
        });
    }

    /**
     * Устанавливает динамические ссылки для кнопок добавления подписки.
     */
    function setSubscriptionLinks() {
        try {
            // Используем try-catch на случай, если btoa() не поддерживается или fullUrl некорректен
            const encodedFullUrlBase64 = btoa(fullUrl); // Кодируем URL в Base64 один раз

            // iOS
            document.getElementById("ios-streisand-add").href = `streisand://import/${fullUrl}`;
            document.getElementById("ios-v2box-add").href = `v2box://install-sub?url=${encodeURIComponent(fullUrl)}&name=${username}`;
            document.getElementById("ios-singbox-add").href = `sing-box://import-remote-profile?url=${encodeURIComponent(fullUrl)}#${username}`;
            // === НОВОЕ: Добавляем ссылки для Shadowrocket и foXray ===
            document.getElementById("ios-shadowrocket-add").href = `sub://${encodedFullUrlBase64}`;
            document.getElementById("ios-foxray-add").href = `foxray://yiguo.dev/sub/add/?url=${encodedFullUrlBase64}#${username}`; // Используем Base64 URL и username


            // Android
            document.getElementById("android-v2rayng-add").href = `v2rayng://install-config?url=${encodeURIComponent(fullUrl)}`; // v2rayng обычно ожидает URL-encoded
            document.getElementById("android-nekobox-add").href = `sn://subscription?url=${encodeURIComponent(fullUrl)}&name=${username}`;
            document.getElementById("android-singbox-add").href = `sing-box://import-remote-profile?url=${encodeURIComponent(fullUrl)}#${username}`;


            // Windows (Clash Verge использует deeplink)
            document.getElementById("windows-clashverge-add").href = `clash://install-config?url=${encodeURIComponent(fullUrl)}`;
            // Для других Windows клиентов (v2rayN, NekoRay) используем копирование ссылки.

        } catch (error) {
            console.error("Ошибка при кодировании URL или установке ссылок:", error);
            // Можно оповестить пользователя или отключить кнопки
            alert("Не удалось сформировать ссылки для добавления подписки.");
        }
    }

    /**
     * Обновляет информацию о пользователе на странице.
     */
    function updateUserInfo() {
        // Статус
        const statusBadge = document.getElementById('user-status-badge');
        let statusText = 'Неизвестно';
        let badgeClass = 'bg-secondary';
        switch (userStatus) {
            case 'active':
                statusText = 'Активен';
                badgeClass = 'bg-success';
                break;
            case 'limited':
                statusText = 'Ограничен';
                badgeClass = 'bg-warning text-dark';
                break;
            case 'expired':
                statusText = 'Просрочен';
                badgeClass = 'bg-danger';
                break;
            case 'disabled':
                statusText = 'Отключен';
                badgeClass = 'bg-secondary';
                break;
        }
        statusBadge.textContent = statusText;
        statusBadge.className = `badge ${badgeClass}`; // Обновляем классы

        // Дата окончания
        const expireDateEl = document.getElementById('expire-date');
        if (expireTimestamp) {
            const date = new Date(expireTimestamp * 1000);
            expireDateEl.textContent = date.toLocaleString('ru-RU', { dateStyle: 'long', timeStyle: 'short' });
        } else {
            expireDateEl.textContent = 'Бессрочно';
        }

        // Информация о сбросе
        const resetInfoEl = document.getElementById('reset-info');
        let resetText = '';
        switch (resetStrategy) {
            case 'day': resetText = 'Трафик сбрасывается ежедневно'; break;
            case 'week': resetText = 'Трафик сбрасывается еженедельно'; break;
            case 'month': resetText = 'Трафик сбрасывается ежемесячно'; break;
            case 'year': resetText = 'Трафик сбрасывается ежегодно'; break;
            default: resetText = 'Трафик не сбрасывается'; break;
        }
        resetInfoEl.textContent = (dataLimitBytes > 0) ? resetText : 'Безлимитный тариф';


        // Использование трафика
        const progressBar = document.getElementById('data-usage-bar');
        const trafficUsageText = document.getElementById('traffic-usage-text');
        let usagePercent = 0;
        let barClass = 'bg-success'; // Зеленый по умолчанию

        if (dataLimitBytes > 0) {
            // Рассчитываем процент только если есть лимит
            usagePercent = Math.min(100, Math.round((dataUsedBytes / dataLimitBytes) * 100));
            if (usagePercent >= 80) {
                barClass = 'bg-danger'; // Красный > 80%
            } else if (usagePercent >= 40) {
                barClass = 'bg-warning text-dark'; // Желтый 40-80%
            }
            trafficUsageText.textContent = `Использовано: ${formatBytes(dataUsedBytes)} / ${formatBytes(dataLimitBytes)}`;
            progressBar.style.width = `${usagePercent}%`;
            progressBar.setAttribute('aria-valuenow', usagePercent);
            progressBar.textContent = `${usagePercent}%`;
        } else {
            // Безлимит
            usagePercent = 0; // Прогресс не показываем как заполненный
            barClass = 'bg-info'; // Используем синий для безлимита
            trafficUsageText.textContent = `Использовано: ${formatBytes(dataUsedBytes)} / ∞`;
            progressBar.style.width = `100%`; // Заполняем фон полностью
            progressBar.setAttribute('aria-valuenow', 0); // Значение 0, т.к. лимита нет
            progressBar.textContent = `Безлимит`; // Пишем "Безлимит"
        }

        progressBar.className = `progress-bar progress-bar-striped progress-bar-animated ${barClass}`; // Обновляем классы
    }

    /**
     * Генерирует QR-код.
     */
    function generateQrCode() {
        const qrCodeElement = document.getElementById('qrcode');
        qrCodeElement.innerHTML = ''; // Очищаем предыдущий QR-код, если он был
        try {
            new QRCode(qrCodeElement, {
                text: fullUrl, // Используем полную URL подписки для QR
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H // Высокий уровень коррекции ошибок
            });
        } catch (error) {
            console.error("Ошибка генерации QR кода:", error);
            qrCodeElement.textContent = "Не удалось сгенерировать QR-код.";
        }
    }

    // ----- Выполнение при загрузке DOM -----
    document.addEventListener('DOMContentLoaded', () => {
        updateUserInfo(); // Сначала обновляем инфо, чтобы переменные были доступны
        setSubscriptionLinks(); // Затем устанавливаем ссылки, использующие эти переменные

        // Открытие аккордеона для ОС пользователя (опционально)
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        let targetAccordionId = null;
        if (/android/i.test(userAgent)) {
            targetAccordionId = "#collapseAndroid";
        } else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
            targetAccordionId = "#collapseIos";
        } else if (/Win/.test(userAgent)) {
            targetAccordionId = "#collapseWindows";
        } else if (/Mac/.test(userAgent)) {
            targetAccordionId = "#collapseMacOs"; // Используем macOS секцию
        }

        if (targetAccordionId) {
            const targetCollapseElement = document.querySelector(targetAccordionId);
            if (targetCollapseElement && bootstrap) { // Убедимся, что bootstrap загружен
                // Используем Bootstrap API для показа аккордеона
                const bsCollapse = bootstrap.Collapse.getOrCreateInstance(targetCollapseElement, {
                    toggle: false // Не переключать, если уже открыт
                });
                // Добавим небольшую задержку, чтобы избежать возможных проблем с отрисовкой
                setTimeout(() => bsCollapse.show(), 100);
            }
        }

        // Инициализация генерации QR-кода при показе модального окна
        const qrModalElement = document.getElementById('qrModal');
        if (qrModalElement) {
            qrModalElement.addEventListener('shown.bs.modal', generateQrCode);
        }

        // Обновляем значение в поле ввода для копирования
        const subLinkInput = document.getElementById('subLinkInput');
        if (subLinkInput) {
            subLinkInput.value = fullUrl;
        }

    });

</script>

</body>
</html>
